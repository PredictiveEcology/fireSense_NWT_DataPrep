---
title: "fireSense_NWT_DataPrep"
author: "Jean Marchal"
date: "February, 2019"
output: html_document
---

The purpose of this file is to prepare the climate and vegetation data needed to run the fireSense modules for BCR6 and BCR6 contained in the Northwest Territories.

# Setup
```{r packages, message=FALSE}
library(dplyr)
library(ff)
library(lubridate)
library(raster)
library(reproducible)
library(sf)
library(sp)
library(tibble)
library(tidyselect)

options(reproducible.overwrite = TRUE)
knitr::opts_chunk$set(eval = FALSE)
```

# Prepare ClimateNA inputs - 250m and 1km resolution
```{R}
#
# Need to have 3 things: lat, long, elevation
#
#
## Load BCR6_RT, raster version of the BCR6 study area
#
BCR6_RT_250m <- prepInputs(
  url = "https://drive.google.com/open?id=1sEiXKnAOCi-f1BF7b4kTg-6zFlGr0YOH",
  targetFile = "bcr6.tif"
)

DEM_BCR6_250m <- prepInputs(
  url = "https://drive.google.com/open?id=1_7L8QDozDtGSuYWBKKkgzCABocR9lWVN"
)

#
## Produce 1km versions of BCR6 and DEM
#
BCR6_RT_1km <- Cache(
  aggregate,
  BCR6_RT_250m,
  fact = 4
)

DEM_BCR6_1km <- Cache(
  postProcess,
  DEM_BCR6_250m,
  method = "bilinear",
  rasterToMatch = BCR6_RT_1km,
  maskWithRTM = TRUE
)

prep_ClimateNA_inputs <- function(res)
{
  BCR6 <- get(paste0("BCR6_RT_", res))
  DEM <- get(paste0("DEM_BCR6_", res))
  
  withinBCR6 <- !is.na(BCR6[])
  elev <- DEM[withinBCR6]
  
  #
  ## Parts of the BCR6 where we have no data, after manual inspection, they are pixels
  ## in the sea. Confirmed by Diana. Remove these pixels from BCR6.
  #
  withinBCR6 <- which(withinBCR6)[!is.na(elev)]
  elev <- elev[!is.na(elev)]
  
  #
  # Write lat, long, elev to csv
  #
  np <- 8 # Split in 8 parts to stay within memory limits and because we have 8 threads available...
  wp <- rep(1:np, length.out = length(elev))
  
  for (i in 1:np)
  {
    write.csv(
      (
        bind_cols(
          (
            st_as_sf(
              as_tibble(
                raster::xyFromCell(BCR6, withinBCR6[wp == i])
              ),
              coords = c("x", "y"),
              crs = proj4string(DEM)
            ) %>%
              st_transform(crs = 4326) %>%
              st_coordinates() %>%
              as_tibble() %>%
              rename(lat = Y, long = X)
          ),
          tibble(el = elev[wp == i])
        ) %>%
          mutate(ID1 = withinBCR6[wp == i], ID2 = "") %>%
          dplyr::select(ID1, ID2, lat, long, el)
      ),
      file = paste0("climateNA_inputs", i, "_", res, ".csv"),
      row.names = FALSE,
      eol = "\r\n" # ClimateNA is windows software
    )
  }
}
```

### Read and filter ClimateNA outputs
Climate variables are described in the [AdaptWest paper](https://dx.doi.org/10.1371/journal.pone.0156720)
```{R}
# Add a check for NA (-9999 value)

climateNA_outputs <- read.csv.ffdf(
  file = "C:/climateNA_inputs_1995-2015AMT.csv", 
  header = TRUE, 
  colClasses = c("integer", "integer", "factor", rep("numeric", 171))
)

climateNA_outputs <- climateNA_outputs[
  ,
  vars_select(
    colnames(climateNA_outputs), 
    Year, ID1, Latitude, Longitude, 
    num_range("Tmax", 4:9, 2), num_range("PPT",  4:9, 2)
  )
]
```

### Calculate MDC (April - September)
Calculate the Monthly Drought Code following [Bergeron et al. 2010](https://dx.doi.org/10.1071/WF09092):

$$Q = 800e^{-DC/400}$$
$$E_m = n(0.36(\bar{T}_{mx}) + L_f)$$
$$DC_{HALF} = MDC_0 + 0.25E_m$$
$$Q_{mr} = 3.937RM_{EFF}/800e^{-MDC_0/400}$$
$$DC_{mr} = DC_{HALF} - 400ln(1+Q_{mr})$$
$$MDC_m = DC_{mr} + 0.25E_m$$
$$MDC = (MDC_0 + MDC_m) / 2$$

Abbreviations:

  * $DC_{HALF}$: drying taking place over the first half of the month
  * $DC_{mr}$: drying taking place over the middle of the month
  * $MDC_0$: MDC from the end of the previous month
  * $MDC_m$: MDC at the end of the month
  * $E_m$: evapotranspiration over month
  * $L_f$: standard day-length adjustement factor
  * $n$: number of days in the month
  * $Q$: moisture equivalent
  * $Q_{mr}$: moisture equivalent in the layer after rain
  * $r_m$: total monthly rainfall
  * $RM_{EFF}$: effective rainfall
  * $T_{mx}$: monthly mean of daily max temperatures

```{R}
# Day length adjustement L_f in Drought Code (taken from Van Wagner 1987)
L_f <- function(month)
{
  c(
    '4' = 0.9, 
    '5' = 3.8,
    '6' = 5.8, 
    '7' = 6.4, 
    '8' = 5.0,
    '9' = 2.4
  )[[as.character(month)]]
}

MDC_0 <- 0

for (i in 4:9)
{
  n <- unname(days_in_month(date(paste0(climateNA_outputs[["Year"]], "-0", i, "-01"))))
  T_mx <- climateNA_outputs[[paste0("Tmax0", i)]] # Max monthly temperature
  r_m <- climateNA_outputs[[paste0("PPT0", i)]] # Total monthly precip
  E_m <- n * (.36 * T_mx + L_f(i))
  RM_EFF <- .83 * r_m
  Q_mr <- 3.937 * RM_EFF / (800 * exp(-MDC_0/400))
  DC_HALF <- MDC_0 + .25 * E_m
  DC_mr <- DC_HALF - 400 * log(1 + Q_mr)
  MDC_m <- DC_mr + .25 * E_m
  climateNA_outputs[[paste0("MDC0", i)]] <- MDC_0 <- (MDC_0 + MDC_m) / 2
}
```

### Produce Monthly Drought Code rasters for the 2000-2010 period and the BCR6 study area, 250m resolution
``` {R}
invisible(
  lapply(
    2000:2010,
    function(year)
    {
      for (month in 4:9)
      {
        BCR6_RT[climateNA_outputs[climateNA_outputs[["Year"]] == year, "ID1"] <-
                  climateNA_outputs[climateNA_outputs[["Year"]] == year, paste0("MDC", month)]
        writeRaster(BCR6_RT, filename = paste0("MDC0", month, "_", year, "_BCR6_250m.tif"))
      }
    }
  )
)
```

# Vegetation
### Load LCC05_BCR6, LCC05_BCR6_NWT
```{r LCC05_GIS}
#
# Load LCC05_BCR6
#
LCC05_BCR6 <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1SioQYtK4BRloaOJAWCwBLNqV28_baOcA", 
  filename2 = NULL
)

#
# Load LCC05_BCR6_NWT
#
LCC05_BCR6_NWT <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1WhL-DxrByCbzAj8A7eRx3Y1FVujtGmtN",
  filename2 = NULL
)
```

### Reclassify LCC2005 (39 classes)

|Description|Code|
| ------------------------------------------- |-----:|
|Temperate or subpolar needle-leaved evergreen closed tree canopy|1|
|Cold deciduous closed tree canopy|2|
|Mixed needle-leaved evergreen – cold deciduous closed tree canopy|3|
|Mixed needle-leaved evergreen – cold deciduous closed young tree canopy|4|
|Mixed cold deciduous - needle-leaved evergreen closed tree canopy|5|
|Temperate or subpolar needle-leaved evergreen medium density, moss-shrub understory|6|
|Temperate or subpolar needle-leaved evergreen medium density, lichen-shrub understory|7|
|Temperate or subpolar needle-leaved evergreen low density, shrub-moss understory|8|
|Temperate or subpolar needle-leaved evergreen low density, lichen (rock) understory|9|
|Temperate or subpolar needle-leaved evergreen low density, poorly drained|10|
|Cold deciduous broad-leaved, low to medium density|11|
|Cold deciduous broad-leaved, medium density, young regenerating|12|
|Mixed needle-leaved evergreen - cold deciduous, low to medium density|13|
|Mixed cold deciduous - needle-leaved evergreen, low to medium density|14|
|Low regenerating young mixed cover|15|
|High-low shrub dominated|16|
|Grassland|17|
|Herb-shrub-bare cover|18|
|Wetlands|19|
|Sparse needle-leaved evergreen, herb-shrub cover|20|
|Polar grassland, herb-shrub|21|
|Shrub-herb-lichen-bare|22|
|Herb-shrub poorly drained|23|
|Lichen-shrub-herb-bare soil|24|
|Low vegetation cover|25|
|Cropland-woodland|26|
|High biomass cropland|27|
|Medium biomass cropland|28|
|Low biomass cropland|29|
|Lichen barren|30|
|Lichen-sedge-moss-low shrub wetland|31|
|Lichen-spruce bog|32|
|Rock outcrops|33|
|Recent burns|34|
|Old burns|35|
|Urban and Built-up|36|
|Water bodies|37|
|Mixes of water and land|38|
|Snow/ice|39|
\  

Reclassified as:
\  

|Description|Code|
| ---- | -----:|
|Conifer|1|
|Crops|2|
|Deciduous|3|
|Disturbed|4|
|Mixed C-dom|5|
|Mixed Young|6|
|Mixed F-dom|7|
|Non-vascular|8|
|Open-conifer|9|
|Shrub|10|
|Wetlands|11|

\  

```{R Reclassify LCC05 39 classes}
rcl <- matrix(
  #   from,   to,   becomes
  c(     -1,  0.01,      14, # After visual inspection, likely herbs/shrubs
       0.99,  1.01,       1,
       1.99,  2.01,       5,
       2.99,  3.01,       7,
       3.99,  4.01,       8,
       4.99,  5.01,       9,
       5.99, 10.01,       1,
      10.99, 12.01,       5,
      12.99, 13.01,       7,
      13.99, 14.01,       9,
      14.99, 15.01,       6,
      15.99, 16.01,      14,
      16.99, 17.01,      10,
      17.99, 18.01,      14,
      18.99, 19.01,      15, # Wetlands, waiting for Tati's update
      19.99, 20.01,      11,
      20.99, 24.01,      14,
      24.99, 25.01,      10,
      25.99, 29.01,       4,
      29.99, 31.01,      10,
      31.99, 32.01,      15, # Wetlands (here lichen-spruce bog), waiting for Tati's update
      32.99, 33.01,       0, # do not burn
      33.99, 35.01,       6,
      35.99, 39.01,       0  # do not burn
  ),
  ncol = 3,
  byrow = TRUE
)


LCC05_BCR6_rcl <- Cache(reclassify, x = LCC05_BCR6, rcl = rcl)
LCC05_BCR6_NWT_rcl <- Cache(reclassify, x = LCC05_BCR6_NWT, rcl = rcl)
```

### LCC05 with incremental disturbances
```{R}
NFDB_PO_BCR6_NWT <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=15Fl6XCsNTZtA2G3py0Ma5ZTaESWwn622",
  targetFile = "NFDB_poly_20180726_BCR6_NWT.shp",
  alsoExtract = "similar",
  fun = "sf::st_read"
)

prop_disturbed <- lapply(
  2000:2010,
  function(year)
  {
    Cache(
      rasterize,
      x = as(
        st_union(
          filter(NFDB_PO_BCR6_NWT, YEAR > (year - 15) & YEAR <= year)
        ),
        "Spatial"
      ),
      y = LCC05_BCR6_NWT, 
      getCover = TRUE
    )
  }
)

invisible(
  mapply(
    prop_disturbed,
    year = 2000:2010,
    function(x, year)
    {
      LCC05_BCR6_NWT_rcl[x[] >= .5] <- 6 # Code for disturbed areas
      writeRaster(LCC05_BCR6_NWT_rcl, filename = paste0("LCC05_BCR6_NWT_rcl_", year, ".tif"))
    },
    SIMPLIFY = FALSE,
    USE.NAMES = FALSE
  )
)
```


### Calculate the proportion covered by each class of land cover at 10km resolution, 2000-2010 period
```{R}
n_lcc <- 12

pp_lcc_10k <- 
  lapply(
    0:(n_lcc - 1),
    function(cl_i)
    {
      calc_prop_lcc <- function(x, cl = cl_i, na.rm = TRUE)
      {
        if (anyNA(x)) return(NA)
        sum(x == cl, na.rm = na.rm) / 1600
      }
      
      col_name <- paste0("cl", cl_i)
      
      tibble(
        !!col_name := aggregate(LCC05_BCR6_NWT_rcl, fact = 40, fun = calc_prop_lcc)[]
      )
    }
  ) %>% bind_cols %>% rowid_to_column(var = "PX_ID") %>% filter_at(2, all_vars(!is.na(.)))
```


# Fire data
### Prepare point data
```{R}
NFDB_PT_BCR6_NWT <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1HU2lGMYmMoyXkDVjYLGhvAiC0ZkY-XMg",
  targetFile = "NFDB_point_20181129_BCR6_NWT.shp",
  alsoExtract = "similar",
  fun = sf::st_read
)

NFDB_PT_BCR6_NWT <- NFDB_PT_BCR6_NWT %>%
  # Filter fire data (2000 - 2010 period)
  filter(YEAR >= 2000 & YEAR <= 2010) %>%
  
  # Drop columns containing info we don't need
  select(LATITUDE, LONGITUDE, YEAR, SIZE_HA, CAUSE) %>%

  # Keep only lightning fires
  filter(CAUSE == "L")
```




