---
title: "fireSense_NWT_DataPrep"
author: "Jean Marchal"
date: "January 31, 2019"
output: html_document
---

The purpose of this file is to prepare the climate and vegetation data needed to run the fireSense modules for the Northwest Territories.

# Setup
```{r packages, message=FALSE}
library(dplyr)
library(raster)
library(reproducible)
library(sf)
library(sp)
library(tibble)

options(reproducible.overwrite = TRUE)
```

# Climate
## Create csv file with the lat, long, elevation needed by ClimateNA
```{R Prepare ClimateNA inputs}
#
# Latitude, longitude
#
## Load BCR6 (raster)
#
BCR6 <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1sEiXKnAOCi-f1BF7b4kTg-6zFlGr0YOH",
  targetFile = "bcr6.tif"
)

BCR6_NWT_VT <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1Zn2FTohJv_j0p1Fy0SHBYPj-QR1Ue6BP"
)

```


```{R Read climateNA ouputs}
# Load CSV files with monthly variables
```

# Vegetation
## Load LCC05_BCR6, LCC05_BCR6_NWT
```{r LCC05_GIS}
#
# Load LCC05_BCR6
#
LCC05_BCR6 <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1z5sw3Z6tSEANa3xhO73mNzT9nIMhtAsy", 
  filename2 = NULL
)

#
# Load LCC05_BCR6_NWT
#
LCC05_BCR6_NWT <- Cache(
  prepInputs,
  url = "https://drive.google.com/open?id=1_IjMnvEpghM7hCUNKDrScRamnCXNhKfv",
  filename2 = NULL
)
```

## Reclassfiy LCC2005 (39 classes)

|Description|Code|
| ------------------------------------------- |-----:|
|Temperate or subpolar needle-leaved evergreen closed tree canopy|1|
|Cold deciduous closed tree canopy|2|
|Mixed needle-leaved evergreen – cold deciduous closed tree canopy|3|
|Mixed needle-leaved evergreen – cold deciduous closed young tree canopy|4|
|Mixed cold deciduous - needle-leaved evergreen closed tree canopy|5|
|Temperate or subpolar needle-leaved evergreen medium density, moss-shrub understory|6|
|Temperate or subpolar needle-leaved evergreen medium density, lichen-shrub understory|7|
|Temperate or subpolar needle-leaved evergreen low density, shrub-moss understory|8|
|Temperate or subpolar needle-leaved evergreen low density, lichen (rock) understory|9|
|Temperate or subpolar needle-leaved evergreen low density, poorly drained|10|
|Cold deciduous broad-leaved, low to medium density|11|
|Cold deciduous broad-leaved, medium density, young regenerating|12|
|Mixed needle-leaved evergreen - cold deciduous, low to medium density|13|
|Mixed cold deciduous - needle-leaved evergreen, low to medium density|14|
|Low regenerating young mixed cover|15|
|High-low shrub dominated|16|
|Grassland|17|
|Herb-shrub-bare cover|18|
|Wetlands|19|
|Sparse needle-leaved evergreen, herb-shrub cover|20|
|Polar grassland, herb-shrub|21|
|Shrub-herb-lichen-bare|22|
|Herb-shrub poorly drained|23|
|Lichen-shrub-herb-bare soil|24|
|Low vegetation cover|25|
|Cropland-woodland|26|
|High biomass cropland|27|
|Medium biomass cropland|28|
|Low biomass cropland|29|
|Lichen barren|30|
|Lichen-sedge-moss-low shrub wetland|31|
|Lichen-spruce bog|32|
|Rock outcrops|33|
|Recent burns|34|
|Old burns|35|
|Urban and Built-up|36|
|Water bodies|37|
|Mixes of water and land|38|
|Snow/ice|39|
\  

Reclassified as:

|Description|Code|
| -------------------------------- |-----:|
|Conifer|1|
|Crops|2|
|Deciduous|3|
|Disturbed|4|
|Mixed C-dom|5|
|Mixed Young|6|
|Mixed F-dom|7|
|Non-vascular|8|
|Open-conifer|9|
|Shrub|10|
|Wetlands|11|

\  
```{R Reclassify LCC05 39 classes}
rcl <- matrix(
  #   from,  to,    becomes
  c(     -1,  0.01,      10, # After visual inspection, likely croplands
       0.99,  1.01,       1,
       1.99,  2.01,       3,
       2.99,  3.01,       5,
       3.99,  4.01,       6,
       4.99,  5.01,       7,
       5.99, 10.01,       1,
      10.99, 12.01,       3,
      12.99, 13.01,       5,
      13.99, 14.01,       7,
      14.99, 15.01,       4,
      15.99, 16.01,      10,
      16.99, 17.01,       8,
      17.99, 18.01,      10,
      18.99, 19.01,      11, # Wetlands, waiting for Tati's update
      19.99, 20.01,       9,
      20.99, 24.01,      10,
      24.99, 25.01,       8,
      25.99, 29.01,       2,
      29.99, 31.01,       8,
      31.99, 32.01,      11, # Wetlands (here lichen-spruce bog), waiting for Tati's update
      32.99, 33.01,      NA,
      33.99, 35.01,       4,
      35.99, 39.01,      NA
  ),
  ncol = 3,
  byrow = TRUE
)


LCC05_BCR6_rcl <- Cache(reclassify, x = LCC05_BCR6, rcl = rcl)
LCC05_BCR6_NWT_rcl <- Cache(reclassify, x = LCC05_BCR6_NWT, rcl = rcl)
```

## Aggregate at 10km resolution
```{R}
#
# Create an aggregation template which will be used to keep only pixels entirely
# inside BCR6_NWT
#
agg_tmpl <- aggregate(LCC05_BCR6_NWT, fact = 40)
isWithinBCR6_NWT <- rasterize(BCR6_NWT_VT, agg_tmpl, getCover = TRUE)[] == 1
agg_tmpl[!isWithinBCR6_NWT] <- NA

#
# Discard pixels of LCC05_BCR6_NWT not entirely inside BCR6_NWT
#
LCC05_BCR6_NWT_rcl[is.na(agg_tmpl[])] <- NA

#
# Compute the proportion of each Land Cover Class
#
n_lcc <- 11

test <- lapply(
  1:n_lcc,
  function(cl_i)
  {
    calc_prop_lcc <- function(x, cl = cl_i, na.rm = TRUE)
    {
      sum(x == cl, na.rm = na.rm) / 1600
    }
    
    aggregate(LCC05_BCR6_NWT_rcl, fact = 40, fun = calc_prop_lcc)
  }
)

#



```
